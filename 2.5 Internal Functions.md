# 🧩 Backend Internal Functions

This document lists all reusable internal functions in the Poker Backend application to prevent code duplication.

## 📁 app_core/poker_event/
### 📌 utils.py
>
>---
>#### ▶️ validate_init_data()
>    Validates the initData string passed from Telegram WebApp using HMAC-SHA256.
>    *Note: Ensures the request originates from Telegram.*
>
>>**Parameters:**
>>
>>| Parameter   | Type     | Required | Description                                             | Origin                                                           |
>>|-------------|----------|----------|---------------------------------------------------------|------------------------------------------------------------------|
>>| `init_data` | `string` | Yes      | Raw URL-encoded initData string from Telegram WebApp. | `request.data['initData']` in [`views.verify_telegram_user`](#️-verify_telegram_user) |
>>
>>**Return:**
>>
>>`boolean`: `True` if the data's hash matches the computed hash, `False` otherwise.
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/utils.py
>>def validate_init_data(init_data: str) -> bool:
>>    ...
>>    return hmac.compare_digest(computed_hash, hash_to_check)
>>```
>>
>> **Sample Call:**
>>```python
>># app_core/poker_event/views.py -> verify_telegram_user
>>if not validate_init_data(init_data):
>>    return Response(...)
>>```
>>
>
>---
### 📌 models.py
>---
>#### ▶️  set_auth_key()
>    Securely hashes and stores authentication keys using Django's password hashing utilities.
>
>>**Parameters:**
>>
>>| Parameter | Type      | Required | Description                                               | Origin                                                            |
>>|-----------|-----------|----------|-----------------------------------------------------------|-------------------------------------------------------------------|
>>| `raw_key` | `string`  | Yes      | The plain-text authentication key to be hashed and stored. | [`validate`](#️-validate) `attrs['auth_key']` (from Telegram initData) |
>>
>>**Return:**
>>
>>`None`
>>
>>* It modifies the `auth_key_hash` attribute of the instance
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/models.py -> class Player
>>def set_auth_key(self, raw_key):
>>```
>>
>> **Sample Call:**
>>```python
>># app_core/poker_event/serializers.py -> VerifyUserSerializer.validate
>>auth_key = attrs.get("auth_key") #auth_key comes from init data of telegram
>>...
>>player.set_auth_key(auth_key) 
>>```
>>
>
>---
>#### ▶️  check_auth_key()
>    Validates a provided authentication key against the stored hash.
>
>>**Parameters:**
>>
>>| Parameter | Type      | Required | Description                                                         | Origin                                                            |
>>|-----------|-----------|----------|---------------------------------------------------------------------|-------------------------------------------------------------------|
>>| `raw_key` | `string`  | Yes      | The plain-text authentication key to validate against the stored hash. | [`validate`](#️-validate) `attrs['auth_key']` (from Telegram initData) |
>>
>>**Return:**
>>
>>Returns a `boolean` value:
>>- `True`: If the provided `raw_key` matches the stored `auth_key_hash`.
>>- `False`: If the provided `raw_key` does not match.
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/models.py -> class Player
>>def check_auth_key(self, raw_key):
>>```
>>
>> **Sample Call:**
>>```python
>># app_core/poker_event/serializers.py -> VerifyUserSerializer.validate
>>player = Player.objects.filter(telegram_id=telegram_id).first()
>>...
>>if player.check_auth_key(auth_key): # Check the provided key
>>```
>---
>#### ▶️  update_last_login()
>    Updates the player's last login timestamp and saves only that specific field.
>    *Note: While this method exists, the [`VerifyUserSerializer.save`](#️-save) method currently updates the timestamp directly.*
>
>>**Parameters:**
>>
>>| Parameter | Type      | Required | Description                            | Origin        |
>>|-----------|-----------|----------|----------------------------------------|---------------|
>>| `self`    | `Player`  | Implicit | The instance of the Player model itself. | Method call   |
>>
>>**Return:** 
>>
>>`None`
>>
>>* It modifies the `last_login` instance of the player and saves the change to the database. 
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/models.py -> class Player
>>def update_last_login(self):
>>```
>>
>> **Sample Call:**
>>```python
>># NOTE: This method is currently not called directly in the codebase.
>># The 'VerifyUserSerializer.save' method updates 'last_login' manually.
>># If it were to be used, a potential call site might look like this:
>>
>># Example hypothetical usage:
>>player.update_last_login() # Call the method to update timestamp
>>
>># The current direct update happening in VerifyUserSerializer.save:
>># player = self.validated_data["player"]
>># player.last_login = now()
>># player.save(update_fields=["last_login"])
>>```
>>
### 📌 serializers.py
>
>#### 📃 PlayerSerializer
>
>#### 📃 VerifyUserSerializer
>>---
>>##### ▶️ to_internal_value()
>>    Transforms raw initData input into structured data.
>>    *Note: This method is part of the `VerifyUserSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                | Origin                                                               |
>>>|-----------|--------|----------|----------------------------|----------------------------------------------------------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.   | DRF internal call                                                  |
>>>| `data`    | `dict` | Yes      | Raw input data.            | HTTP POST body -> [`views.verify_telegram_user`](#️-verify_telegram_user) (contains `initData`) |
>>>
>>>**Return:**
>>>
>>>`dict` containing the structured user data extracted from `initData`.
>>>
>>>**Function Definition:**
>>>```python
>>># app_core/poker_event/serializers.py
>>>def to_internal_value(self, data):
>>>    ...
>>>    return {"telegram_id": ..., "first_name": ..., "last_name": ..., "photo_url": ..., "auth_key": ...}
>>>```
>>>
>>> **Sample Call:**
>>>```python
>>># Called internally by DRF during serializer validation (is_valid())
>>># N/A for direct manual call example
>>>```
>>
>>---
>>##### ▶️ validate()
>>    Checks if user exists, verifies authentication key, or registers a new user.
>>    *Note: This method is part of the `VerifyUserSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                    | Origin                                                                |
>>>|-----------|--------|----------|--------------------------------|---------------------------------------------------------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.       | DRF internal call                                                 |
>>>| `attrs`   | `dict` | Yes      | Dictionary of validated data.  | Output of [`to_internal_value`](#️-to_internal_value) via DRF |
>>>
>>>**Return:**
>>>
>>>`dict` containing the validated attributes (`attrs`), potentially modified (e.g., adding the `player` object).
>>>
>>>**Function Definition:**
>>>```python
>>># app_core/poker_event/serializers.py
>>>def validate(self, attrs):
>>>    ...
>>>    return attrs
>>>```
>>>
>>> **Sample Call:**
>>>```python
>>># Called internally by DRF during serializer validation (is_valid())
>>># N/A for direct manual call example
>>>```
>>
>>---
>>##### ▶️ save()
>>    Updates last login timestamp and returns user data.
>>    *Note: This method is part of the `VerifyUserSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                            | Origin              |
>>>|-----------|--------|----------|----------------------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance (uses `validated_data`). | DRF `serializer.save()` |
>>>
>>>**Return:**
>>>
>>>`dict` containing the player's `balance` and `win_points`.
>>>
>>>**Function Definition:**
>>>```python
>>># app_core/poker_event/serializers.py
>>>def save(self):
>>>    ...
>>>    return {"balance": player.balance, "win_points": player.win_points}
>>>```
>>>
>>> **Sample Call:**
>>>```python
>>># app_core/poker_event/views.py -> verify_telegram_user
>>>player_data = serializer.save()
>>>```
>
>#### 📃 CreateGameSerializer
>>---
>>##### ▶️ create()
>>    Creates a new game instance using the provided data.
>>    *Note: This method is part of the `CreateGameSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                            | Origin              |
>>>|-----------|--------|----------|----------------------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.               | DRF internal call |
>>>| `validated_data` | `dict` | Yes | The validated data for creating a game. | DRF `serializer.save()` |
>>>
>>>**Return:**
>>>
>>>`Game` object that was created.
>>>
>>>**Function Definition:**
>>>```python
>>># app_core/poker_event/serializers.py
>>>def create(self, validated_data):
>>>    # Implementation details under development
>>>```
>>
>>---
>>##### ▶️ get_repeat_count()
>>    Returns the number of times a game should repeat based on its regularity setting.
>>    *Note: This method is part of the `CreateGameSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                | Origin              |
>>>|-----------|--------|----------|----------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.   | Method call |
>>>| `regularity` | `string` | Yes | The regularity setting (weekly, fortnightly, monthly). | From validated data |
>>>
>>>**Return:**
>>>
>>>`int` representing the number of repeat events to create.
>>>
>>>**Function Definition:**
>>>```python
>>># Under development
>>>```
>>
>>---
>>##### ▶️ get_next_date()
>>    Calculates the next event date based on regularity.
>>    *Note: This method is part of the `CreateGameSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                | Origin              |
>>>|-----------|--------|----------|----------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.   | Method call |
>>>| `current_date` | `date` | Yes | The date to calculate from. | Game date from validated data |
>>>| `regularity` | `string` | Yes | The regularity setting. | From validated data |
>>>| `multiplier` | `int` | Yes | Which occurrence to calculate. | Iteration counter |
>>>
>>>**Return:**
>>>
>>>`date` object with the calculated next date.
>>>
>>>**Function Definition:**
>>>```python
>>># Under development
>>>```
>>
>>---
>>##### ▶️ schedule_future_game_sessions()
>>    Creates separate future game sessions based on regularity setting.
>>    *Note: This method is part of the `CreateGameSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                | Origin              |
>>>|-----------|--------|----------|----------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.   | Method call |
>>>| `regularity` | `string` | Yes | The regularity setting. | From validated data |
>>>| `base_game` | `Game` | Yes | The original game object. | Newly created game |
>>>| `game_date` | `date` | Yes | The original game date. | From validated data |
>>>| `game_data` | `dict` | Yes | Game configuration data. | From validated data |
>>>
>>>**Return:**
>>>
>>>List of `Game` objects that were created as future occurrences.
>>>
>>>**Function Definition:**
>>>```python
>>># Under development
>>>```
>>
>>---
>>##### ▶️ post_to_social_media()
>>    Posts game details to Facebook and Telegram asynchronously.
>>    *Note: This method is part of the `CreateGameSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                | Origin              |
>>>|-----------|--------|----------|----------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.   | Method call |
>>>| `game` | `Game` | Yes | The game object to post about. | Newly created game |
>>>
>>>**Return:**
>>>
>>>None. Posts to social media platforms asynchronously.
>>>
>>>**Function Definition:**
>>>```python
>>># Under development
>>>```
>
>#### 📃 AllGameSerializer
>>---
>>##### ▶️ get_host()
>>    Retrieves the telegram_id, first_name, last_name of the Game host.
>>    *Note: This method is part of the `AllGameSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                | Origin              |
>>>|-----------|--------|----------|----------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.   | DRF internal call |
>>>| `obj` | `Game` | Yes | The game object being serialized. | From queryset |
>>>
>>>**Return:**
>>>
>>>`string` containing formatted host information.
>>>
>>>**Function Definition:**
>>>```python
>>># Under development
>>>```
>
>#### 📃 JoinGameSerializer
>>---
>>##### ▶️ create()
>>    Handles adding a player to a Game.
>>    *Note: This method is part of the `JoinGameSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                | Origin              |
>>>|-----------|--------|----------|----------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.   | DRF internal call |
>>>| `validated_data` | `dict` | Yes | The validated data for joining a game. | DRF `serializer.save()` |
>>>
>>>**Return:**
>>>
>>>`GameSessionPlayer` object representing the player joining the game.
>>>
>>>**Function Definition:**
>>>```python
>>># Under development
>>>```
>
>#### 📃 GameDetailSerializer
>>---
>>##### ▶️ get_player_count()
>>    Count the number of players in the game.
>>    *Note: This method is part of the `GameDetailSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                | Origin              |
>>>|-----------|--------|----------|----------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.   | DRF internal call |
>>>| `obj` | `Game` | Yes | The game object being serialized. | From queryset |
>>>
>>>**Return:**
>>>
>>>`int` representing the count of players in the game.
>>>
>>>**Function Definition:**
>>>```python
>>># Under development
>>>```
>
>#### 📃 JoinedPlayerSerializer
>>---
>>##### ▶️ get_payment_status()
>>    Check if the player has paid the deposit for the game.
>>    *Note: This method is part of the `JoinedPlayerSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                | Origin              |
>>>|-----------|--------|----------|----------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.   | DRF internal call |
>>>| `obj` | `Player` | Yes | The player object being serialized. | From queryset |
>>>
>>>**Return:**
>>>
>>>`string` with payment status (e.g., "paid", "pending").
>>>
>>>**Function Definition:**
>>>```python
>>># Under development
>>>```
>
>#### 📃 HostingGameSerializer
>>---
>>##### ▶️ get_players_joined()
>>    Fetch players who joined the game.
>>    *Note: This method is part of the `HostingGameSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                | Origin              |
>>>|-----------|--------|----------|----------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.   | DRF internal call |
>>>| `obj` | `Game` | Yes | The game object being serialized. | From queryset |
>>>
>>>**Return:**
>>>
>>>Serialized list of joined players with their details.
>>>
>>>**Function Definition:**
>>>```python
>>># Under development
>>>```
>
>#### 📃 JoinedGameSerializer
>>---
>>##### ▶️ get_player_count()
>>    Count the number of players in the game.
>>    *Note: This method is part of the `JoinedGameSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                | Origin              |
>>>|-----------|--------|----------|----------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.   | DRF internal call |
>>>| `obj` | `Game` | Yes | The game object being serialized. | From queryset |
>>>
>>>**Return:**
>>>
>>>`int` representing the count of players in the game.
>>>
>>>**Function Definition:**
>>>```python
>>># Under development
>>>```
>
>#### 📃 PlayerJoiningSerializer
>>---
>>##### ▶️ get_joining_details()
>>    Retrieve all games the player has joined.
>>    *Note: This method is part of the `PlayerJoiningSerializer`.*
>>
>>>**Parameters:**
>>>
>>>| Parameter | Type   | Required | Description                | Origin              |
>>>|-----------|--------|----------|----------------------------|---------------------|
>>>| `self`    | `Serializer` | Implicit | The serializer instance.   | DRF internal call |
>>>| `obj` | `Player` | Yes | The player object being serialized. | From queryset |
>>>
>>>**Return:**
>>>
>>>Serialized list of games the player has joined with details.
>>>
>>>**Function Definition:**
>>>```python
>>># Under development
>>>```
>

## 📁 app_core/social/
### 📌 facebook.py
>
>---
>#### ▶️ post_to_facebook()
>>Under development   
>
### 📌 telegram.py
>
>---
>#### ▶️ post_to_telegram()
>>Under development   

## 📁 api/
### 📌 settings.py
>
>---
>#### ▶️ get_env_variable()
>>Under development   
>
>---

### 📌 views.py
>
>---
>#### ▶️ verify_telegram_user()
>    Handles the verification and authentication of a user based on Telegram initData and manages user registration or login.
>
>>**Parameters:**
>>
>>| Parameter | Type      | Required | Description                        | Origin                                  |
>>|-----------|-----------|----------|------------------------------------|-----------------------------------------|
>>| `request` | `Request` | Yes      | The incoming HTTP request object.  | Django rest framework (contains `initData`) |
>>
>>**Return:**
>>
>>`Response` object:
>>- HTTP 200: User exists, last login updated
>>- HTTP 201: New user created 
>>- HTTP 400: Missing data
>>- HTTP 401: Invalid authentication
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/views.py
>>@api_view(["POST"])
>>def verify_telegram_user(request):
>>    ...
>>    return Response(...)
>>```
>>
>> **Sample Call:**
>>```python
>># Called via HTTP POST request to the mapped URL
>># Example client call: requests.post(URL, data={"initData": "..."})
>>```
>>
>
>---
>#### ▶️ get_all_players()
>>Under development   
>
>---
>#### ▶️ createGame()
>>Under development   
>
>---
>#### ▶️ getAllGames()
>>Under development   
>
>---
>#### ▶️ joinGame()
>>Under development   
>
>---
>#### ▶️ getGameDetails()
>>Under development   
>
>---
>#### ▶️ get_hosting_details()
>>Under development   
>
>---
>#### ▶️ get_joining_details()
>>Under development   

## 📁 app_scheduler/
### 📌 jobs.py
>
>---
>#### ▶️ scheduled_job()
>>Under development   
>
>---
### 📌 apps.py
>
>---
>#### ▶️ ready()
>>Under development   
>
>---

## 📁 ./ (Root)
### 📌 manage.py
>
>---
>#### ▶️ main()
>>Under development   
>