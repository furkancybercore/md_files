# 🧩 Backend Internal Functions

This document lists all reusable internal functions in the Poker Backend application to prevent code duplication.

## 📁 app_core/poker_event/
### 📌 utils.py
>---
>>#### ▶️validate_init_data()
>> * Ensures the request originates from Telegram.
>> * Validates the initData string passed from Telegram WebApp using HMAC-SHA256.
>>
>>**Parameters:**
>>
>>| Parameter   | Type     | Required | Description                                             | Origin                                                           |
>>|-------------|----------|----------|---------------------------------------------------------|------------------------------------------------------------------|
>>| `init_data` | `string` | Yes      | Raw URL-encoded initData string from Telegram WebApp.   | Client request. Example: <br> [`require_telegram_self`](#️require_telegram_self) |
>>
>>**Return:**
>>
>>`boolean`: <br>-`True`: if the data's hash matches the computed hash <br>-`False`: otherwise
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/utils.py
>>def validate_init_data(init_data: str) -> bool:
>>    # ... hashing and comparison logic ...
>>    return hmac.compare_digest(computed_hash, hash_to_check)
>>```
>>
>> **Sample Call:**
>>```python
>># app_core/poker_event/auth.py -> require_telegram_self
>>if not validate_init_data(init_data):
>>    return Response(...)
>>```
>---
>>#### ▶️get_valid_telegram_user_data()
>> * Parses and returns the Telegram user data from initData.
>> * Use only after successful validation of initData.
>>
>>**Parameters:**
>>
>>| Parameter   | Type     | Required | Description                                           | Origin                                                       |
>>|-------------|----------|----------|-------------------------------------------------------|--------------------------------------------------------------|
>>| `init_data` | `string` | Yes      | Raw URL-encoded initData string from Telegram WebApp. | Client request. Example: <br> [`views.verify_telegram_user`] |
>>
>>**Return:**
>>
>> -`dict`: A dictionary containing the user's data (`id`, `first_name`, `last_name`, etc.) if parsing is successful. <br>-`None`: Otherwise.
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/utils.py
>>def get_valid_telegram_user_data(init_data: str):
>>  # ... parsing logic ...
>>  return (json.loads(parsed['user']))
>>```
>>
>> **Sample Call:**
>>```python
>># app_core/poker_event/views.py -> verify_telegram_user
>>user_data = get_valid_telegram_user_data(init_data)
>>```
>---
>>#### ▶️get_valid_telegram_id()
>> * Parses and extracts the Telegram user ID from initData.
>> * Use only after successful validation of initData.
>>
>>**Parameters:**
>>
>>| Parameter   | Type     | Required | Description                                             | Origin                                                           |
>>|-------------|----------|----------|---------------------------------------------------------|------------------------------------------------------------------|
>>| `init_data` | `string` | Yes      | Raw URL-encoded initData string from Telegram WebApp.   | Client request. Example: <br> [`require_telegram_self`](#️require_telegram_self) |
>>
>>**Return:**
>>
>>-`Big int`: The user's Telegram ID if found and valid <br>-`None`: otherwise.
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/utils.py
>>def get_valid_telegram_id(init_data: str):
>>    # ... parsing logic ...
>>    return telegram_id
>>```
>>
>> **Sample Call:**
>>```python
>># app_core/poker_event/auth.py -> require_telegram_self
>>telegram_id = get_valid_telegram_id(init_data)
>>if not telegram_id:
>>    return Response(...)
>>```
>---
>>#### ▶️get_valid_auth_date()
>> * Parses and extracts the authentication timestamp (`auth_date`) from initData.
>> * Use only after successful validation of initData.
>>
>>**Parameters:**
>>
>>| Parameter   | Type     | Required | Description                                             | Origin                                                           |
>>|-------------|----------|----------|---------------------------------------------------------|------------------------------------------------------------------|
>>| `init_data` | `string` | Yes      | Raw URL-encoded initData string from Telegram WebApp. | Client request. Example: <br> [`views.verify_telegram_user`](poker-backend/backend/app_core/poker_event/views.py) |
>>
>>**Return:**
>>
>>-`int`: The Unix timestamp of the authentication if found <br>-`None`: otherwise.
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/utils.py
>>def get_valid_auth_date(init_data: str):
>>    # ... parsing logic ...
>>    return int(auth_date)
>>```
>>
>> **Sample Call:**
>>```python
>># app_core/poker_event/views.py -> verify_telegram_user
>>auth_date = get_valid_auth_date(init_data)
>>```
>---
>>#### ▶️get_first_session_date()
>> * Calculates the datetime of the first valid game session based on recurrence rules.
>> * Searches within a 30-day window from the game's start date.
>>
>>**Parameters:**
>>
>>| Parameter | Type   | Required | Description                 | Origin                                                                    |
>>|-----------|--------|----------|-----------------------------|---------------------------------------------------------------------------|
>>| `game`    | `Game` | Yes      | The Game instance to check. | Called internally. Example: <br> [`views.host_game`] |
>>
>>**Return:**
>>
>>-`datetime`: The datetime object of the first session if found within 30 days. <br>-`None`: Otherwise.
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/utils.py
>>def get_first_session_date(game):
>>    # ... recurrence logic ...
>>    return candidate_dt
>>```
>>
>> **Sample Call:**
>>```python
>># app_core/poker_event/views.py -> host_game (POST)
>>next_session_date = get_first_session_date(game)
>>if next_session_date:
>>    GameSession.objects.create(...)
>>```
>---
### 📌 auth.py
>
>> *Decorators defined in this file. Explained in the [🔐 Decorators](#-decorators) section.*
>---
### 📌 models.py
>---
>>#### ▶️default_roles()
>> * Provides the default role list for a new Player instance.
>> * Used as the `default` value for the `Player.roles` field.
>>
>>**Parameters:**
>>
>> None
>>
>>**Return:**
>>
>>`list`: A list containing the default role(s) (e.g., `['player']`).
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/models.py
>>def default_roles():
>>    return [ROLE_PLAYER]
>>```
>>
>> **Sample Call:**
>>```python
>># app_core/poker_event/models.py -> Player class definition
>>class Player(models.Model):
>>    roles = models.JSONField(default=default_roles)
>>    # ...
>>```
>---
>>#### ▶️Player.set_auth_key()
>> * Will be removed
>---
>>#### ▶️Player.check_auth_key()
>> * Will be removed
>---
>>#### ▶️Player.update_last_login()
>> * Updates the `last_login` field of the Player instance to the current time.
>> * Saves the change to the database.
>>
>>**Parameters:**
>>
>>| Parameter | Type     | Required | Description                        | Origin                                                     |
>>|-----------|----------|----------|------------------------------------|------------------------------------------------------------|
>>| `self`    | `Player` | Yes      | The Player instance to update.     | Called on a Player object instance. e.g., [`@Player.update_last_login`](#️Player.update_last_login) |
>>
>>**Return:**
>>
>>`None`
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/models.py
>>class Player(models.Model):
>>    # ... other fields ...
>>    def update_last_login(self):
>>        self.last_login = now()
>>        self.save(update_fields=['last_login'])
>>```
>>
>> **Sample Call:**
>>```python
>># app_core/poker_event/views.py -> verify_telegram_user
>>player = Player.objects.get(telegram_id=telegram_id)
>>player.update_last_login()
>>```
>---
### 📌 serializers.py
>---
>>#### ▶️InfluencerProfileSerializer.update_or_create()
>> * Under development   
>---
>>#### ▶️HostProfileSerializer.update_or_create()
>> * Under development  
>---
>>#### ▶️JoinGameSerializer.create()
>> * Under development  
>---
>>#### ▶️GameDetailSerializer.get_player_count()
>> * Under development  
>---
>>#### ▶️GameDetailSerializer.get_players()
>> * Under development  
>---
>>#### ▶️JoinedPlayerSerializer.get_payment_status()
>> * Under development  
>---
>>#### ▶️HostingGameSerializer.get_players_joined()
>> * Under development  
>---
>>#### ▶️JoinedGameSerializer.get_player_count()
>> * Under development  
>---
>>#### ▶️JoinedGameSerializer.get_payment_status()
>> * Under development  
>---
>>#### ▶️PlayerJoiningSerializer.get_joining_details()
>> * Under development  
>---
### 📌 views.py
>
>> *No internal functions documented in this file. Views documented here are API endpoints.*
>---

## 📁 app_core/social/
### 📌 facebook.py
>
>>#### ▶️post_to_facebook()
>> Under development
>---
### 📌 telegram.py
>
>>#### ▶️post_to_telegram()
>> Under development
>---

## 📁 app_scheduler/
### 📌 jobs.py
>---
>>#### ▶️generate_upcoming_game_sessions()
>> * Entry point for the daily scheduler job.
>> * Fetches all non-'once' recurring games.
>> * Calls `create_sessions_for_game` for each game to potentially create future sessions.
>>
>>**Parameters:**
>>
>> None
>>
>>**Return:**
>>
>> `None`
>>
>>**Function Definition:**
>>```python
>># app_scheduler/jobs.py
>>def generate_upcoming_game_sessions():
>>    games = Game.objects.exclude(recurrence='once')
>>    # ... loop and call create_sessions_for_game ...
>>```
>>
>> **Sample Call:**
>>```python
>># app_scheduler/apps.py -> ready()
>>scheduler.add_job(
>>    generate_upcoming_game_sessions,
>>    trigger=CronTrigger(hour=5),
>>    # ... other scheduler config ...
>>)
>>```
>---
>>#### ▶️create_sessions_for_game()
>> * Creates future `GameSession` instances for a specific recurring `Game`.
>> * Checks recurrence rules (`daily`, `weekly`, `fortnightly`, `monthly`) against a list of candidate dates.
>> * Ensures no more than `MAX_SESSIONS_PER_GAME` future sessions exist for the game.
>> * Avoids creating duplicate sessions for the same datetime.
>> * Creates sessions in bulk for efficiency.
>>
>>**Parameters:**
>>[`@require_telegram_self`](#️require_telegram_self)
>>| Parameter | Type          | Required | Description                                       | Origin                                                      |
>>|-----------|---------------|----------|---------------------------------------------------|-------------------------------------------------------------|
>>| `game`    | `Game`        | Yes      | The recurring Game instance.                      | Called by [`@generate_upcoming_game_sessions`](#️▶️generate_upcoming_game_sessions).                  |
>>| `days`    | `list[date]`  | Yes      | List of candidate dates (e.g., next 7 days).      | Passed from [`@generate_upcoming_game_sessions`](#️generate_upcoming_game_sessions-).             |
>>
>>**Return:**
>>
>> `None`
>>
>>**Function Definition:**
>>```python
>># app_scheduler/jobs.py
>>def create_sessions_for_game(game, days):
>>    # ... logic to check existing sessions and recurrence rules ...
>>    GameSession.objects.bulk_create(sessions_to_create)
>>```
>>
>> **Sample Call:**
>>```python
>># app_scheduler/jobs.py -> generate_upcoming_game_sessions
>>today = now().date()
>>next_7_days = [today + timedelta(days=i) for i in range(MAX_LOOKAHEAD_DAYS)]
>># ... loop through games ...
>>create_sessions_for_game(game, next_7_days)
>>```
>---
>>#### ▶️scheduled_job()
>> * Dummy function, currently not used.
>>
>>**Parameters:**
>>
>> None
>>
>>**Return:**
>>
>> `None`
>>
>>**Function Definition:**
>>```python
>># app_scheduler/jobs.py
>>def scheduled_job():
>>    """
>>    A scheduled job
>>    """
>>```
>>
>> **Sample Call:**
>>
>> *Currently not called.*
>---
### 📌 apps.py
>---
>>#### ▶️AppSchedulerConfig.ready()
>> * Initializes and configures the APScheduler when the Django app starts.
>> * Sets up the background scheduler and Django job store.
>> * Schedules the `generate_upcoming_game_sessions` job to run daily.
>> * Ensures the scheduler only starts once in development (`runserver`).
>>
>>**Parameters:**
>>
>>| Parameter | Type                 | Required | Description                          | Origin                                                    |
>>|-----------|----------------------|----------|--------------------------------------|-----------------------------------------------------------|
>>| `self`    | `AppSchedulerConfig` | Yes      | The instance of the AppConfig class. | Called automatically by Django during app initialization. |
>>
>>**Return:**
>>
>>`None`
>>
>>**Function Definition:**
>>```python
>># app_scheduler/apps.py
>>class AppSchedulerConfig(AppConfig):
>>    # ... other config ...
>>    def ready(self):
>>        # ... scheduler setup and job adding ...
>>        scheduler.start()
>>```
>>
>> **Sample Call:**
>>
>> *Automatically called by Django on startup.*
>---

## 📁 ./ (Root)
### 📌 manage.py
>---
>>#### ▶️main()
>> * Main entry point for Django's command-line utility (`manage.py`).
>> * Sets the default Django settings module environment variable.
>> * Executes administrative tasks based on command-line arguments.
>>
>>**Parameters:**
>>
>> None (Reads arguments from `sys.argv`)
>>
>>**Return:**
>>
>>`None` (Exits with appropriate status code)
>>
>>**Function Definition:**
>>```python
>># manage.py
>>def main():
>>    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'api.settings')
>>    # ... execute_from_command_line ...
>>```
>>
>> **Sample Call:**
>>```bash
>># Called implicitly when running manage.py commands
>>python manage.py runserver
>>python manage.py migrate
>>```
>---

# 🔐 Decorators
## 📁 app_core/poker_event/
### 📌 auth.py
>
>---
>>#### ▶️require_telegram_self()
>> * Decorator to verify Telegram `initData`.
>> * Attaches `telegram_id` to the request object (`request.telegram_id`) upon successful validation.
>> * Ensures the endpoint is accessed by a validated Telegram user.
>> * Defined in: `app_core/poker_event/auth.py`
>>
>>**Parameters:**
>>
>>| Parameter | Type       | Required | Description                       | Origin                                                              |
>>|-----------|------------|----------|-----------------------------------|---------------------------------------------------------------------|
>>| `func`    | `function` | Yes      | The view function to wrap.        | Applied as a decorator [`@require_telegram_self`](#️require_telegram_self) to view functions. |
>>
>>**Behavior:**
>> * Extracts `initData` from request headers.
>> * Validates `initData` using `utils.validate_init_data()`.
>> * Extracts `telegram_id` using `utils.get_valid_telegram_id()`.
>> * Attaches `telegram_id` to `request.telegram_id`.
>> * Returns HTTP 400/401 Response on failure.
>> * Calls the wrapped function if validation succeeds.
>>
>>**Return:**
>>
>> The wrapped function's `Response` or an error `Response` (HTTP 400 or 401).
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/auth.py
>>def require_telegram_self(func):
>>    @wraps(func)
>>    def wrap(request, *args, **kwargs):
>>        # ... validation logic ...
>>        request.telegram_id = telegram_id
>>        return func(request, *args, **kwargs)
>>    return wrap
>>```
>>
>> **Sample Call:**
>>```python
>># app_core/poker_event/views.py
>>@api_view(["GET"])
>>@require_telegram_self
>>def player_me(request):
>>    # Access telegram_id via request.telegram_id
>>    ...
>>```
>---
>>#### ▶️require_host()
>> * Decorator to check if the authenticated user has the 'host' role.
>> * Attaches the host's `HostProfile` to the request object (`request.host_profile`).
>> * Must be used *after* the `require_telegram_self` decorator.
>> * Defined in: `app_core/poker_event/auth.py`
>>
>>**Parameters:**
>>
>>| Parameter | Type       | Required | Description                       | Origin                                                         |
>>|-----------|------------|----------|-----------------------------------|----------------------------------------------------------------|
>>| `func`    | `function` | Yes      | The view function to wrap.        | Applied as a decorator ([`@require_host`](#️require_host)) to view functions.     |
>>
>>**Behavior:**
>> * Assumes `request.telegram_id` is already set by `require_telegram_self`.
>> * Fetches the `Player` instance using `request.telegram_id`.
>> * Checks if `ROLE_HOST` is present in the player's `roles`.
>> * Fetches and attaches the associated `HostProfile` to `request.host_profile`.
>> * Returns HTTP 404/403 Response on failure (Player not found or not a host).
>> * Calls the wrapped function if the user is a host.
>>
>>**Return:**
>>
>> The wrapped function's `Response` or an error `Response` (HTTP 404 or 403).
>>
>>**Function Definition:**
>>```python
>># app_core/poker_event/auth.py
>>def require_host(func):
>>    @wraps(func)
>>    def wrap(request, *args, **kwargs):
>>        # ... role check logic ...
>>        request.host_profile = player.host_profile
>>        return func(request, *args, **kwargs)
>>    return wrap
>>```
>>
>> **Sample Call:**
>>```python
>># app_core/poker_event/views.py
>>@api_view(["POST", "GET", "PUT"])
>>@require_telegram_self
>>@require_host
>>def host_game(request, game_id=None):
>>    # Access host_profile via request.host_profile
>>    ...
>>```
>---
